<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>urzasight_gpt ‚Äì Always-On</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --ui: #0ea5e9; }
  body { font-family: system-ui, sans-serif; margin: 14px; }
  h1 { margin: 0 0 8px; }
  .row { margin: 10px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  #previewWrap { position: relative; max-width: 92vw; }
  #video { width: 100%; border-radius: 10px; border: 1px solid #ddd; }
  #freeze { display:none; max-width: 92vw; border: 1px solid #ddd; border-radius: 10px; }
  #stage { position: relative; display: inline-block; }
  #box { position:absolute; border:2px solid var(--ui); background: rgba(14,165,233,0.12); display:none; }
  button, select, label { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background:white; }
  button.primary { border-color: var(--ui); }
  .mono { font-family: ui-monospace, Menlo, monospace; white-space: pre-wrap; }
  .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:white; }
  #out { margin-top: 10px; }
</style>
</head>
<body>
  <h1>urzasight_gpt üìñ</h1>

  <div class="row" id="voiceRow">
    <span class="pill">Say: ‚ÄúUrzasight help‚Äù</span>
    <label class="pill"><input type="checkbox" id="vertical" checked> Vertical</label>
    <label class="pill">PSM
      <select id="psm">
        <option value="auto" selected>Paragraph</option>
        <option value="column">Single column</option>
        <option value="line">Single line</option>
      </select>
    </label>
    <label class="pill">Hi-Res Still
      <input type="file" id="hires" accept="image/*" capture="environment" style="display:none;">
      <button id="hiresBtn">Pick</button>
    </label>
  </div>

  <div id="previewWrap">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="row">
    <button id="askBtn" class="primary">Ask urzasight_gpt</button>
    <button id="recaptureBtn" style="display:none;">Recapture</button>
    <button id="explainBtn">Explain</button>
    <button id="speakBtn">Speak Reply</button>
  </div>

  <div id="stage" style="display:none;">
    <img id="freeze" alt="captured frame"/>
    <div id="box"></div>
  </div>

  <div class="row mono" id="out"></div>

<script>
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
if (isIOS) {
  // hide the "Say: ..." pill (iOS has no SpeechRecognition)
  const voiceRow = document.getElementById('voiceRow');
  voiceRow.firstElementChild.style.display = 'none';
}

const video = document.getElementById('video');
const askBtn = document.getElementById('askBtn');
const recaptureBtn = document.getElementById('recaptureBtn');
const explainBtn = document.getElementById('explainBtn');
const speakBtn = document.getElementById('speakBtn');
const vertical = document.getElementById('vertical');
const psm = document.getElementById('psm');
const stage = document.getElementById('stage');
const freeze = document.getElementById('freeze');
const box = document.getElementById('box');
const out = document.getElementById('out');
const hires = document.getElementById('hires');
const hiresBtn = document.getElementById('hiresBtn');

let dragging=false, sx=0, sy=0, ex=0, ey=0;
let lastResult=null;
let lastImageDataURL=null;

// --- Better camera constraints (request higher res rear camera) ---
(async () => {
  try {
    if (!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia unavailable (use HTTPS).');
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height:{ ideal: 1080 },
        frameRate: { ideal: 30 }
      },
      audio: false
    });
    video.srcObject = stream;
  } catch (e) {
    alert("Camera permission needed:\n" + e.message + "\nTip: use HTTPS (https://10.42.0.1:8443).");
  }
})();

// Hi-res still (optional) for tough bubbles
hiresBtn.onclick = () => hires.click();
hires.onchange = async (e) => {
  if (!e.target.files?.[0]) return;
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => showStill(reader.result);
  reader.readAsDataURL(file);
};

function showStill(dataURL){
  lastImageDataURL = dataURL;
  freeze.src = dataURL;
  freeze.style.display = 'block';
  stage.style.display = 'inline-block';
  recaptureBtn.style.display = 'inline-block';
  out.textContent = 'Drag a box over the bubble/kanji, then tap ‚ÄúAsk urzasight_gpt‚Äù.';
  box.style.display = 'none';
  askBtn.onclick = () => analyze(dataURL);
}

askBtn.onclick = triggerCapture;

async function triggerCapture(){
  // Capture current frame to dataURL
  const c = document.createElement('canvas');
  c.width = video.videoWidth || 1920;
  c.height = video.videoHeight || 1080;
  const ctx = c.getContext('2d');
  ctx.drawImage(video, 0, 0, c.width, c.height);
  const dataURL = c.toDataURL('image/jpeg', 0.95);
  showStill(dataURL);
}

// ROI drag
freeze.onload = () => { box.style.display='none'; dragging=false; };
stage.addEventListener('mousedown', (e) => {
  if (freeze.style.display === 'none') return;
  dragging = true;
  const r = freeze.getBoundingClientRect();
  sx = e.clientX - r.left; sy = e.clientY - r.top;
  Object.assign(box.style, {left:sx+'px', top:sy+'px', width:'0px', height:'0px', display:'block'});
});
stage.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  const r = freeze.getBoundingClientRect();
  ex = e.clientX - r.left; ey = e.clientY - r.top;
  const x=Math.min(sx,ex), y=Math.min(sy,ey), w=Math.abs(ex-sx), h=Math.abs(ey-sy);
  Object.assign(box.style, {left:x+'px', top:y+'px', width:w+'px', height:h+'px'});
});
window.addEventListener('mouseup', () => dragging=false);

recaptureBtn.onclick = () => {
  askBtn.onclick = triggerCapture;
  out.textContent = 'Live preview ready. Tap Ask or use Hi-Res Still.';
  stage.style.display = 'none';
  freeze.style.display = 'none';
  recaptureBtn.style.display = 'none';
};

async function analyze(dataURL){
  const r = freeze.getBoundingClientRect();
  const scaleX = freeze.naturalWidth / r.width;
  const scaleY = freeze.naturalHeight / r.height;
  let x=0,y=0,w=0,h=0;
  if (box.style.display !== 'none') {
    const bx = parseInt(box.style.left), by = parseInt(box.style.top);
    const bw = parseInt(box.style.width), bh = parseInt(box.style.height);
    x = Math.round(bx * scaleX); y = Math.round(by * scaleY);
    w = Math.round(bw * scaleX); h = Math.round(bh * scaleY);
  } else {
    out.textContent = 'Tip: draw a tight box around the bubble/kanji for best OCR.';
  }

  const fd = new FormData();
  fd.append('image_b64', dataURL);
  fd.append('x', x); fd.append('y', y); fd.append('w', w); fd.append('h', h);
  fd.append('vertical', document.getElementById('vertical').checked ? 1 : 0);
  fd.append('psm', document.getElementById('psm').value);

  out.textContent = 'Analyzing‚Ä¶';
  const res = await fetch('/capture_analyze', { method: 'POST', body: fd });
  const data = await res.json();
  lastResult = data;

  out.textContent =
    `Japanese: ${data.japanese || '(‚Äî)'}\n` +
    `Reading (hiragana): ${data.readings?.hiragana || '(‚Äî)'}\n` +
    `Translation: ${data.translation}`;
}

explainBtn.onclick = async () => {
  if (!lastResult?.japanese) { out.textContent = 'Nothing to explain yet ‚Äî OCR something first.'; return; }
  const fd = new FormData();
  fd.append('japanese', lastResult.japanese);
  fd.append('context_hint', '');
  const r = await fetch('/explain_gpt', { method: 'POST', body: fd });
  const j = await r.json();
  out.textContent = (j.ok ? j.explanation : ('Explain failed: ' + j.explanation));
};

// Speak (client-side TTS)
function speakBrowser(text){
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
speakBtn.onclick = () => {
  const t = out.textContent.trim();
  speechSynthesis.cancel(); speakBrowser(t || 'No text yet.');
};
</script>
</body>
</html>
